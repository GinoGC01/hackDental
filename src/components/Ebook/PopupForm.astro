---
// src/components/PopupForm.astro
import ArrowRight from "../../Icons/Ebook/ArrowRight.astro"
import Lock from "../../Icons/Candado.astro"
import X from "../../Icons/X.astro"
import CheckCircle from "../../Icons/Ebook/CheckCircle.astro"
import CornerRightDown from "../../Icons/Ebook/CornerRightDown.astro"
import Sparkles from "../../Icons/Ebook/Sparkles.astro"
---

<div id="popup-form" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fadeIn">
  <div class="bg-[#111] rounded-xl shadow-[0_0_50px_rgba(217,32,39,0.15)] max-w-md w-full relative overflow-hidden border border-white/10">
    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-red to-transparent opacity-70"></div>
    <div class="absolute -top-10 -right-10 w-24 h-24 bg-brand-red/20 rounded-full blur-2xl pointer-events-none"></div>
    
    <button id="popup-close" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-20 cursor-pointer">
      <X size="16"/>
    </button>
    
    <div class="w-full bg-[#222] h-1 mt-0 relative">
      <div id="progress-bar" class="bg-gradient-to-r from-brand-red to-orange-500 h-1 transition-all duration-500 ease-out shadow-[0_0_10px_rgba(217,32,39,0.5)]" style="width: 20%" />
    </div>
    
    <div class="p-6 relative z-10">
      <form id="multi-step-form"  novalidate>
        <!-- STEP 1: Email -->
        <div id="step-1" class="form-step">
          <div class="text-center mb-6">
            <span class="inline-flex items-center gap-1.5 bg-[#d4af37]/10 text-[#d4af37] text-[10px] font-bold px-2 py-1 rounded uppercase tracking-widest border border-[#d4af37]/20">
              <Sparkles size="20" color="#bd9d33"/>
              Paso 1 de 2
            </span>
            <h3 class="text-2xl font-bold font-heading text-white mt-4 leading-tight">
              ¬øA d√≥nde enviamos tu copia <span class="text-brand-red">GRATUITA?</span> üéÅ
            </h3>
            <p class="text-gray-400 text-sm mt-2">
              Ingresa tu email para recibir el acceso inmediato al ebook.
            </p>
          </div>
          
          <div class="space-y-5">
            <div class="group/field">
              <div class="flex justify-between items-end mb-1.5">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider group-focus-within/field:text-[#16a34a] transition-colors duration-300">Tu Mejor Email</label>
                <div class="text-[10px] font-bold flex items-center gap-1 transition-all duration-300">
                  <span class="flex items-center gap-1 text-brand-red animate-pulse group-focus-within/field:hidden">
                    Empieza aqu√≠
                    <CornerRightDown color="#D92027" />
                  </span>
                  <span class="hidden group-focus-within/field:flex items-center gap-1 text-[#16a34a]">
                    Escribiendo...
                    <Sparkles size="20" color="#16a34a" />
                  </span>
                </div>
              </div>
              <div class="relative group/input">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-brand-red to-red-600 rounded-lg blur opacity-60 animate-pulse group-focus-within/input:from-[#16a34a] group-focus-within/input:to-emerald-500 group-focus-within/input:animate-none group-focus-within/input:opacity-100 transition-all duration-700"></div>
                <input 
                  required 
                  autofocus 
                  type="email" 
                  name="email" 
                  id="input-email" 
                  placeholder="juan@clinicadental.com"
                  class="relative w-full px-4 py-3 rounded-lg bg-[#1a1a1a] border border-brand-red text-white placeholder-gray-500 focus:outline-none focus:border-[#16a34a] focus:ring-1 focus:ring-[#16a34a]/50 shadow-[0_0_20px_rgba(217,32,39,0.2)] focus:shadow-[0_0_25px_rgba(22,163,74,0.3)] transition-all duration-300 z-10"
                />
              </div>
            </div>
          </div>
          
          <button type="button" data-next-step="2" class="btn-next w-full bg-gradient-to-r from-[#16a34a] via-[#fbbf24] to-[#16a34a] bg-[length:200%_auto] animate-gradient-xy text-black font-black text-lg py-3.5 rounded-lg shadow-[0_4px_0_#14532d] hover:shadow-[0_6px_0_#14532d] hover:scale-[1.02] active:shadow-none active:translate-y-[4px] transition-all flex items-center justify-center gap-2 mt-6 uppercase tracking-wide border-t border-white/40 cursor-pointer">
            CONTINUAR
            <ArrowRight size="20" color="#000000" />
          </button>
          
          <p class="text-[10px] text-center text-gray-500 flex items-center justify-center gap-1.5 mt-4">
            <Lock size="12" color="#697284"/>
            Tus datos est√°n 100% seguros y encriptados.
          </p>
        </div>
        
        <!-- STEP 2: Datos Personales -->
        <div id="step-2" class="form-step hidden">
          <div class="text-center mb-6">
            <span class="inline-flex items-center gap-1.5 bg-[#d4af37]/10 text-[#d4af37] text-[10px] font-bold px-2 py-1 rounded uppercase tracking-widest border border-[#d4af37]/20">
              <Sparkles size="20" color="#bd9d33"/>
              Paso 2 de 2
            </span>
            <h3 class="text-2xl font-bold font-heading text-white mt-4 leading-tight">
              Cu√©ntanos sobre <span class="text-brand-red">ti</span> üë§
            </h3>
            <p class="text-gray-400 text-sm mt-2">
              Necesitamos algunos datos para personalizar tu experiencia.
            </p>
          </div>
          
          <div class="space-y-5">
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Nombre Completo</label>
              <input 
                required 
                type="text" 
                name="nombre" 
                id="input-fullname" 
                placeholder="Ej. Dr. Juan P√©rez Garc√≠a"
                class="w-full px-4 py-3 rounded-lg bg-[#1a1a1a] border border-gray-700 text-white placeholder-gray-600 focus:border-brand-red focus:ring-1 focus:ring-brand-red/50 outline-none transition-all"
              />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Tel√©fono (WhatsApp)</label>
              <input 
                required 
                type="tel" 
                name="telefono" 
                id="input-phone" 
                placeholder="+34 600 000 000"
                class="w-full px-4 py-3 rounded-lg bg-[#1a1a1a] border border-gray-700 text-white placeholder-gray-600 focus:border-brand-red focus:ring-1 focus:ring-brand-red/50 outline-none transition-all"
              />
            </div>
          </div>
          
          <button type="submit" data-next-step="3" class="w-full bg-gradient-to-r from-[#16a34a] via-[#fbbf24] to-[#16a34a] bg-[length:200%_auto] animate-gradient-xy text-black font-black text-lg py-3.5 rounded-lg shadow-[0_4px_0_#14532d] hover:shadow-[0_6px_0_#14532d] hover:scale-[1.02] active:shadow-none active:translate-y-[4px] transition-all flex items-center justify-center gap-2 mt-6 uppercase tracking-wide border-t border-white/40 cursor-pointer">
            DESCARGAR PDF AHORA
            <ArrowRight size="20" color="#000000" />
          </button>

          <p class="py-3 text-xs text-gray-600 mt-5">Tu privacidad es importante para nosotros. HackDental utiliza la informaci√≥n que proporcionas para ponerse en contacto contigo en relaci√≥n con contenido, productos y servicios relevantes para ti. Puedes darte de baja para dejar de recibir este tipo de comunicaciones en cualquier momento. Si deseas obtener m√°s informaci√≥n sobre la protecci√≥n de tus datos en HackDental, consulta nuestra <a href="/politicas" class="text-blue-500 underline">Pol√≠tica de Privacidad.</a></p>

        </div>
        
        <!-- SUCCESS STEP -->
        <div id="step-success" class="form-step hidden text-center py-6 animate-fadeIn">
          <div class="w-20 h-20 bg-[#16a34a]/20 border-2 border-[#16a34a] rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_30px_rgba(22,163,74,0.3)]">
            <CheckCircle size="55" color="#16a34a" />
          </div>
          <h3 class="text-3xl font-bold font-heading text-white mb-3">
            ¬°Felicidades! üéâ
          </h3>
          <p class="text-lg text-gray-300 mb-6 leading-relaxed">
            Tu copia de <strong class="text-white">"Secretos Millonarios del Marketing Dental"</strong> est√° en camino a tu bandeja de entrada. üì©
          </p>
          <div class="bg-yellow-900/20 p-4 rounded border border-yellow-700/30 text-sm text-yellow-200/80 mb-8">
            <p class="font-bold text-yellow-500 mb-1 flex items-center justify-center gap-1">‚ö†Ô∏è IMPORTANTE:</p>
            Si no lo ves en 5 minutos, revisa tu carpeta de SPAM o Promociones.
          </div>
          <button id="popup-close-final" class="text-gray-500 hover:text-white font-medium text-sm transition-colors cursor-pointer">
            Volver a la p√°gina principal
          </button>
        </div>
      </form>
    </div>
    
    <div class="bg-[#0a0a0a] px-8 py-4 text-center border-t border-white/5 relative z-10">
      <p class="text-[10px] text-gray-600 uppercase tracking-widest font-bold">
        Hackdental ‚Ä¢ Marketing para Odont√≥logos ü¶∑
      </p>
    </div>
  </div>
</div>

<script>
  import { ApiService } from '../../api/service.js';

  interface User {
    nombre: string;
    email: string;
    telefono: string;
    from?: string;
  }

  let currentStep = 1;
  const totalSteps = 2;
  
  // Estado inicial del formulario
  const formData: User = {
    email: '',
    nombre: '',
    telefono: '',
    from: 'Ebook'
  };

  // Selectores de UI
  const popup = document.getElementById('popup-form');
  const closeBtn = document.getElementById('popup-close');
  const closeFinalBtn = document.getElementById('popup-close-final');
  const progressBar = document.getElementById('progress-bar');
  const form = document.getElementById('multi-step-form') as HTMLFormElement;

  // Selectores de Inputs espec√≠ficos
  const inputEmail = document.getElementById('input-email') as HTMLInputElement;
  const inputNombre = document.getElementById('input-fullname') as HTMLInputElement;
  const inputTelefono = document.getElementById('input-phone') as HTMLInputElement;

  /**
   * Carga datos del LocalStorage y los inyecta en el DOM y en el estado formData
   */
  function loadPersistedData() {
    const savedData = localStorage.getItem('user');
    if (savedData) {
      try {
        const parsed: User = JSON.parse(savedData);
        
        // Llenar objeto de estado
        if (parsed.email) {
            formData.email = parsed.email;
            if (inputEmail) inputEmail.value = parsed.email;
        }
        if (parsed.nombre) {
            formData.nombre = parsed.nombre;
            if (inputNombre) inputNombre.value = parsed.nombre;
        }
        if (parsed.telefono) {
            // Limpiamos el prefijo si ya existe para no duplicarlo en el input
            const purePhone = parsed.telefono.replace('+34', '');
            formData.telefono = purePhone;
            if (inputTelefono) inputTelefono.value = purePhone;
        }
      } catch (e) {
        console.error("Error parseando datos de LS", e);
      }
    }
  }

  function openPopup() {
    loadPersistedData(); // Autorrelleno al abrir
    popup?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closePopup() {
    popup?.classList.add('hidden');
    document.body.style.overflow = '';
    currentStep = 1;
    updateUI();
  }

  function updateUI() {
    const progress = (currentStep / totalSteps) * 100;
    if (progressBar) progressBar.style.width = `${progress}%`;
    
    document.querySelectorAll('.form-step').forEach((step, index) => {
      if (index + 1 === currentStep) {
        step.classList.remove('hidden');
      } else {
        step.classList.add('hidden');
      }
    });
  }

  function validateCurrentStep() {
    const currentStepEl = document.getElementById(`step-${currentStep}`);
    if (!currentStepEl) return false;

    const inputs = currentStepEl.querySelectorAll('input[required]') as NodeListOf<HTMLInputElement>;
    let isValid = true;

    inputs.forEach(input => {
      if (!input.checkValidity()) {
        input.classList.add('border-red-500', 'animate-shake'); // Feedback visual de error
        isValid = false;
      } else {
        input.classList.remove('border-red-500');
      }
    });

    return isValid;
  }

  /**
   * Captura los valores de los inputs del paso actual y los guarda en el estado
   */
  function syncStateWithInputs() {
    if (inputEmail?.value) formData.email = inputEmail.value;
    if (inputNombre?.value) formData.nombre = inputNombre.value;
    if (inputTelefono?.value) formData.telefono = inputTelefono.value;
  }

  // Manejo de botones "Continuar"
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const btnNext = target.closest('.btn-next');

    if (btnNext) {
      e.preventDefault();
      if (validateCurrentStep()) {
        syncStateWithInputs();
        currentStep++;
        updateUI();
      }
    }
  });

  // Env√≠o final del formulario
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!validateCurrentStep()) return;
    
    syncStateWithInputs();

    try {
      // Preparamos el cuerpo para la API
      const payload = {
        ...formData,
        telefono: formData.telefono.startsWith('+') ? formData.telefono : `+34${formData.telefono}`
      };

      // PERSISTENCIA: Guardamos en LocalStorage
      localStorage.setItem('user', JSON.stringify(payload));

      const res = await ApiService.sendData(payload);
      
      if (res.success) {
        window.location.href = "/gracias-ebook";
      }
      else if(!res.success && 'email-registered'){
         window.location.href = "https://wa.me/34600000000?text=Hola,%20me%20interesa%20saber%20m√°s%20sobre%20sus%20servicios%20de%20marketing%20dental";
      }
       else {
        currentStep = 3; 
        updateUI();
      }
    } catch (err) {
      console.error("Error en el env√≠o:", err);
    }
  });

  // Event Listeners standard
  closeBtn?.addEventListener('click', closePopup);
  closeFinalBtn?.addEventListener('click', closePopup);

  document.querySelectorAll('[data-popup-trigger]').forEach(trigger => {
    trigger.addEventListener('click', openPopup);
  });

  popup?.addEventListener('click', (e) => {
    if (e.target === popup) closePopup();
  });
</script>