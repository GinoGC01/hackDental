---
import Layout from '../layouts/Layout.astro';
import RedLine from '../Icons/RedLine.astro';
import Candado from '../Icons/Candado.astro';
import Spain from '../Icons/Spain.astro';
import Alert from '../components/Alerts/Alert.astro';
---

<Layout>
    <main class="flex flex-col md:flex-row items-start md:items-center justify-between px-4 md:px-8 lg:px-16 m-auto pt-12 md:pt-0 max-w-[1400px] md:gap-16 relative md:min-h-[100vh] py-12 md:py-0">
        <div class="md:basis-1/2 w-full relative">
            <Alert 
                id="warning1"
                color="#fdc700"
                widthMD="400px"
                width="120px"
                message="⚠ Email registrado! revise nuevamente sus datos, quizas ya solicito la auditoria!"
            />
            <Alert 
                id="error1"
                color="#ff4d4f"
                widthMD="400px"
                width="120px"
                message="✖ Error al enviar el formulario, intentelo mas tarde"
            />
            <Alert 
                id="success1"
                color="#52c41a"
                widthMD="400px"
                width="120px"
                message="✔ Solicitud enviada con exito! Nos estaremos comunicando con usted a la brevedad"
            />
            <div class="max-w-2xl">
                <!-- Heading -->
                <div class="mb-12">
                    <h1 class="text-[24px] md:text-[36px] leading-[1.2] font-bold mb-4 font-oswald">
                        <span class=" text-[#d9d9d9]">RECIBE UNA AUDITORÍA DE</span>
                        <div>
                            <div class="relative inline">
                                MARKETING DENTAL
                                 <!-- Subrayado -->
                            <figure class="absolute bottom-[-2px] left-0 w-full">
                                <RedLine />
                            </figure>
                            </div>
                            <span class=" text-[#d9d9d9]">HECHA POR EL</span> 
                        </div> 
                        <span class=" text-[#d9d9d9]">FUNDADOR NUESTRA AGENCIA</span>
                    </h1>
                </div>
                <!-- Pasos -->
                <div class="mb-12 space-y-4">
                    <h2 class="text-[18px] font-semibold mb-6 text-[#d9d9d9]">PASOS PARA APLICAR:</h2>
                    <div class="space-y-3 text-gray-300">
                        <div class="grid items-center gap-1 grid-cols-[40px_1fr]">
                            <div class="flex items-center justify-center w-[30px] h-[30px] bg-[#039683]/10 rounded-lg">
                                <span class="text-[#0B665A] text-[12px] font-black text-center w-[20px] h-[20px] bg-[#039683] flex items-center justify-center rounded-full">1</span>
                            </div>
                            <p class="flex items-start text-[17px]">
                                Llena tus datos en la forma.
                            </p>
                        </div>
                        <div class="grid items-center gap-1 grid-cols-[40px_1fr]">
                            <div class="flex items-center justify-center w-[30px] h-[30px] bg-[#039683]/10 rounded-lg">
                                <span class="text-[#0B665A] text-[12px] font-black text-center w-[20px] h-[20px] bg-[#039683] flex items-center justify-center rounded-full">2</span>
                            </div>
                            <p class="flex items-start text-[17px]">
                                Espera 24 horas
                            </p>
                        </div>
                        <div class="grid items-center gap-1 grid-cols-[40px_1fr]">
                            <div class="flex items-center justify-center w-[30px] h-[30px] bg-[#039683]/10 rounded-lg">
                                <span class="text-[#0B665A] text-[12px] font-black text-center w-[20px] h-[20px] bg-[#039683] flex items-center justify-center rounded-full">3</span>
                            </div>
                            <p class="flex items-start text-[17px]">
                                El fundador de Hackdental se contactará contigo para agendar una reunión.
                            </p>
                        </div>

                        <div class="flex items-center gap-2 mt-[40px]">
                            <p>Tabien aplicar por WhatsApp:</p>
                            <strong class="text-primary">+51 903300422</strong>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        <!-- Form -->
        <div class="bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl pt-16 pb-8 px-6 md:px-8 md:basis-[45%] lg:basis-[40%] relative w-full md:w-auto md:h-[600px] shadow-[0_0_50px_rgba(3,150,131,0.15),0_20px_60px_rgba(0,0,0,0.3),inset_0_1px_0_rgba(255,255,255,0.1)] flex justify-center flex-col">
            <div class="absolute w-full top-0 left-0 p-2 rounded-t-2xl bg-[#831022]/60 border-b border-white/10 text-center">
                <p class="text-center text-[10px] md:text-[13px]">Solo aplica si tu consultorio dental esta ubicado en España</p>
            </div>
            <!-- Progress Indicator -->
            <div class="mb-2">
                <div id='currentSetpConainer' class="flex items-center gap-2 justify-center relative w-[70%] m-auto mb-2">
                    <span id="currentStep" class="text-sm text-[#d9d9d9] font-black text-[16px] md:text-[40px] leading-tight">ÚLTIMO PASO</span>
                     <div class="absolute bottom-[-10px] left-0" id="redLine">
                        <RedLine />
                     </div>
                </div>
            </div>

            <form id="contactForm" class="flex flex-col justify-center items-center w-full h-[60%]" novalidate>
                <!-- Step 1 -->
                <div id="step1" class="step-content w-full ">
                    <div class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium mb-2">
                                Email <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                required
                                placeholder="Ingresa un email válido"
                                class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                            >
                            <p class="text-xs text-gray-400 mt-2">Te enviaremos los detalles de la auditoría</p>
                        </div>
                    </div>

                    <button 
                        type="button"
                        id="nextStep1"
                        class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] mt-6 cursor-pointer"
                    >
                        Continuar
                    </button>
                </div>

                <!-- Step 2 -->
                <div id="step2" class="step-content hidden w-full ">
                    <div class="space-y-6">
                         <div>
                            <label for="nombre" class="block text-sm font-medium mb-2">
                                Nombre y Apellido <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="nombre" 
                                name="nombre" 
                                required
                                placeholder="Ej: Juan Pérez"
                                class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                            >
                        </div>

                        <div>
                            <label for="website" class="block text-sm font-medium mb-2">
                                Sitio Web <span class="text-gray-400 text-xs">(opcional)</span>
                            </label>
                            <input 
                                type="url" 
                                id="website" 
                                name="website" 
                                placeholder="https://tuconsultorio.com"
                                class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                            >
                        </div>
                        <div>
                            <label for="telefono" class="block text-sm font-medium mb-2">
                                Número de Teléfono (España) <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <div class="absolute left-4 top-1/2 -translate-y-1/2 flex items-center gap-2 pointer-events-none">
                                    <Spain size="24" />
                                    <span class="text-white text-sm">+34</span>
                                    <span class="text-white/40">|</span>
                                </div>
                                <input 
                                    type="tel" 
                                    id="telefono" 
                                    name="telefono" 
                                    required
                                    placeholder="600 000 000"
                                    class="w-full pl-[100px] pr-4 py-3 bg-black/30 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                                >
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Ingresa tu número sin el código de área</p>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button 
                            type="button"
                            id="prevStep2"
                            class="w-1/3 bg-white/10 hover:bg-white/20 text-white font-semibold py-4 rounded-lg transition-all duration-300"
                        >
                            Atrás
                        </button>
                        <button 
                            type="button"
                            id="nextStep2"
                            class="w-2/3 bg-primary hover:bg-primary/90 text-white font-semibold py-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98]"
                        >
                            Continuar
                        </button>
                    </div>
                </div>

                <!-- Step 3 - NUEVO: Ingresos Anuales -->
                <div id="step3" class="step-content hidden w-full ">
                    <div class="space-y-6">
                        <div>
                            <label for="ingresos" class="block text-sm font-medium mb-2">
                                Ingresos Anuales (€) <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="number" 
                                id="ingresos" 
                                name="ingresos"
                                min="0"
                                step="1000"
                                placeholder="Ej: 250000"
                                class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                            >
                            <p class="text-xs text-gray-400 mt-2">Aproximado de facturación anual de tu consultorio</p>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button 
                            type="button"
                            id="prevStep3"
                            class="w-1/3 bg-white/10 hover:bg-white/20 text-white font-semibold py-4 rounded-lg transition-all duration-300"
                        >
                            Atrás
                        </button>
                        <button 
                            type="button"
                            id="nextStep3"
                            class="w-2/3 bg-primary hover:bg-primary/90 text-white font-semibold py-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98]"
                        >
                            ir al ultimo paso
                        </button>
                    </div>
                </div>

                <div id="step4" class="step-content hidden w-full ">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium mb-4">
                                ¿Cuál es tu objetivo principal? <span class="text-red-500">*</span>
                            </label>
                            <div class="space-y-3">
                                <label class="block cursor-pointer radio-option">
                                    <input 
                                        type="radio" 
                                        name="objetivo" 
                                        value="mas-pacientes"
                                        class="hidden"
                                    >
                                    <div class="radio-card border border-white/20 rounded-lg p-4 hover:border-white/40 transition-all">
                                        <div class="flex items-center justify-between">
                                            <span class="text-white">Conseguir más pacientes</span>
                                            <div class="radio-indicator w-5 h-5 rounded-full border-2 border-white/40 flex items-center justify-center">
                                                <div class="w-2 h-2 rounded-full bg-white hidden"></div>
                                            </div>
                                        </div>
                                    </div>
                                </label>

                                <label class="block cursor-pointer radio-option">
                                    <input 
                                        type="radio" 
                                        name="objetivo" 
                                        value="alto-valor"
                                        class="hidden"
                                    >
                                    <div class="radio-card border border-white/20 rounded-lg p-4 hover:border-white/40 transition-all">
                                        <div class="flex items-center justify-between">
                                            <span class="text-white">Atraer pacientes de alto valor</span>
                                            <div class="radio-indicator w-5 h-5 rounded-full border-2 border-white/40 flex items-center justify-center">
                                                <div class="w-2 h-2 rounded-full bg-white hidden"></div>
                                            </div>
                                        </div>
                                    </div>
                                </label>

                                <label class="block cursor-pointer radio-option">
                                    <input 
                                        type="radio" 
                                        name="objetivo" 
                                        value="presencia-marca"
                                        class="hidden"
                                    >
                                    <div class="radio-card border border-white/20 rounded-lg p-4 hover:border-white/40 transition-all">
                                        <div class="flex items-center justify-between">
                                            <span class="text-white">Mejorar mi presencia de marca</span>
                                            <div class="radio-indicator w-5 h-5 rounded-full border-2 border-white/40 flex items-center justify-center">
                                                <div class="w-2 h-2 rounded-full bg-white hidden"></div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button 
                            type="submit"
                            class="block w-full bg-primary hover:bg-primary/90 text-white font-semibold py-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] cursor-pointer grid place-items-center "
                            id="submitBtn"
                        >
                        <span id="text_submitBtn">Si, quiero mi auditoria</span>
                        <span
                            id="loader"
                            class="block h-4 w-4 animate-spin rounded-full border-2 border-white/30 border-t-white hidden"
                        ></span>
                            
                        </button>
                    </div>
                </div>

                <p class="text-xs text-gray-400 text-center mt-6 flex items-center justify-center gap-2">
                    <Candado size="16" color="#99A1AF"/>
                    Tus datos están seguros y protegidos
                </p>
            </form>  
        </div>
    </main>
</Layout>

<script>
    import {ApiService} from '../api/service.js';
    let currentStep = 1;

    function updateProgress() {
        const currentSetpContainer = document.getElementById('currentSetpConainer');
        const redLine = document.getElementById('redLine');
        const currentStepText = document.getElementById('currentStep');
        const contactForm = document.getElementById('contactForm');

        
        if ( currentStepText && currentSetpContainer && redLine && contactForm ) {
            if (currentStep === 1) {
                currentStepText.innerText = 'ÚLTIMO PASO';
                currentStepText.className = 'text-sm text-[#d9d9d9] font-black text-[16px] md:text-[40px] leading-tight';
                currentSetpContainer.className = 'flex items-center gap-2 justify-center relative w-[70%] m-auto mb-2';
                redLine.classList.remove('hidden');
                contactForm.className = 'flex flex-col justify-center items-center w-full h-[60%]';
            } else if (currentStep === 2) {
                currentStepText.innerText = 'INGRESA TU INFORMACION AQUI PARA RECIBIR TU AUDITORIA';
                currentStepText.className = 'text-[28px] text-[#d9d9d9] font-black text-[16px] md:text-[25px] leading-tight';
                currentSetpContainer.className = 'flex items-center gap-2 justify-center relative w-full m-auto mb-2';
                redLine.classList.add('hidden')
                contactForm.className = 'flex flex-col justify-center items-center w-full h-[90%]';
            } else if (currentStep === 3) {
                currentStepText.innerText = 'CUENTANOS MAS SOBRE TU CONSULTORIO';
                currentStepText.className = 'text-[28px] text-[#d9d9d9] font-black text-[16px] md:text-[28px] leading-tight';
                currentSetpContainer.className = 'flex items-center gap-2 justify-center relative w-full m-auto mb-2';
                redLine.classList.add('hidden');
                contactForm.className = 'flex flex-col justify-center items-center w-full h-[60%]';
            } else if (currentStep === 4) {
                currentStepText.innerText = '¿LISTO PARA DISCUTIR EL FUTURO DE TU CONSULTORIO DENTAL?';
                currentStepText.className = 'text-[28px] text-[#d9d9d9] font-black text-[16px] md:text-[25px] leading-tight';
                currentSetpContainer.className = 'flex items-center gap-2 justify-center relative w-full m-auto mb-2';
                redLine.classList.add('hidden');
                contactForm.className = 'flex flex-col justify-center items-center w-full h-[90%]';
            }
            
        }
    }

    function showStep(step: number) {
        document.querySelectorAll('.step-content').forEach(el => {
            el.classList.add('hidden');
        });
        const stepElement = document.getElementById(`step${step}`);
        if (stepElement) {
            stepElement.classList.remove('hidden');
        }
        currentStep = step;
        updateProgress();
    }

    function validateStep1(): boolean {
        const email = (document.getElementById('email') as HTMLInputElement).value.trim();
        
        if (!email) {
            alert('Por favor completa todos los campos obligatorios');
            return false;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Por favor ingresa un email válido');
            return false;
        }
        
        return true;
    }

    function validateStep2(): boolean {
        const nombre = (document.getElementById('nombre') as HTMLInputElement).value.trim();
        const telefono = '+34 '+ (document.getElementById('telefono') as HTMLInputElement).value.trim();
        
        if (!telefono) {
            alert('Por favor ingresa tu número de teléfono');
            return false;
        }
        const phoneRegex = /^\+34\d{9}$/;
        if (!phoneRegex.test(telefono.trim().replace(/\s/g, ''))) {
            console.log('Telefono ingresado:', telefono.trim().replace(/\s/g, ''));
            alert('Por favor ingresa un número de teléfono válido de España');
            return false;
        }

        if(!nombre) {
            alert('Por favor ingresa tu nombre y apellido');
            return false;
        }
        
        return true;
    }

    function validateStep3(): boolean {
        const ingresos = (document.getElementById('ingresos') as HTMLInputElement).value.trim();
        
        if (!ingresos) {
            alert('Por favor ingresa los ingresos anuales aproximados');
            return false;
        }

        const ingresosNum = parseInt(ingresos);
        if (isNaN(ingresosNum) || ingresosNum < 0) {
            alert('Por favor ingresa un valor válido para los ingresos');
            return false;
        }
        
        return true;
    }

    document.getElementById('nextStep1')?.addEventListener('click', () => {
        if (validateStep1()) {
            showStep(2);
        }
    });

    document.getElementById('nextStep2')?.addEventListener('click', () => {
        if (validateStep2()) {
            showStep(3);
        }
    });

    document.getElementById('nextStep3')?.addEventListener('click', () => {
        if (validateStep3()) {
            showStep(4);
        }
    });

    document.getElementById('prevStep2')?.addEventListener('click', () => {
        showStep(1);
    });

    document.getElementById('prevStep3')?.addEventListener('click', () => {
        showStep(2);
    });

   
  document.getElementById("contactForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
    const loader = document.getElementById("loader") as HTMLElement;
    const text_submitBtn = document.getElementById("text_submitBtn") as HTMLElement;
    const warning1 = document.getElementById("warning1") as HTMLElement;
    const success1 = document.getElementById("success1") as HTMLElement;
    const error1 = document.getElementById("error1") as HTMLElement;

    try {
      const objetivo = (
        document.querySelector(
          'input[name="objetivo"]:checked'
        ) as HTMLInputElement | null
      )?.value;

      if (!objetivo) {
        alert("Por favor selecciona tu objetivo principal");
        return;
      }

      if (submitBtn && loader) {
        submitBtn.disabled = true;
        submitBtn.classList.add("opacity-50");
        loader.classList.remove("hidden");
        text_submitBtn.classList.add("hidden");
      }

      // ACTUALIZADO: Incluir ingresos en formData
      const formData = {
        nombre: (document.getElementById("nombre") as HTMLInputElement)?.value,
        email: (document.getElementById("email") as HTMLInputElement)?.value,
        website: (document.getElementById("website") as HTMLInputElement)?.value,
        telefono:
          "+34" +
          (document.getElementById("telefono") as HTMLInputElement)?.value,
        ingresos: (document.getElementById("ingresos") as HTMLInputElement)?.value,
        objetivo,
      };

      const response = await ApiService.sendData(formData);

      console.log("Respuesta del servidor:", response);

      if (response) {
         if(response.success) {success1.classList.remove('hidden');
            setTimeout(() => {
                if(success1) success1.classList.add('hidden');
            }, 7000);} 
        if(response.warning === 'email-registered') {
            if(warning1) warning1.classList.remove('hidden');
            setTimeout(() => {
                if(warning1) warning1.classList.add('hidden');
            }, 7000);
        } else {
            if(warning1) warning1.classList.add('hidden');
        }

        (e.target as HTMLFormElement).reset();
        showStep(1);
      } else {
            if(error1) error1.classList.remove('hidden');
            setTimeout(() => {
                if(error1) error1.classList.add('hidden');
            }, 7000);
      }
    } catch (error) {
      console.error("Error al enviar el formulario:", error);
       if(error1) error1.classList.remove('hidden');
            setTimeout(() => {
                if(error1) error1.classList.add('hidden');
            }, 5000);
    } finally {
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.classList.remove("opacity-50");
      } 
      if (loader) loader.classList.add("hidden");
      if (text_submitBtn) text_submitBtn.classList.remove("hidden");
    }
  });




    document.querySelectorAll('.radio-option').forEach(label => {
        label.addEventListener('click', function(this: HTMLElement) {
            const radioCards = document.querySelectorAll('.radio-card') as NodeListOf<HTMLElement>;
            radioCards.forEach(card => {
                card.classList.remove('border-primary', 'bg-primary/10');
                card.classList.add('border-white/20');
            });
            const radioIndicators = document.querySelectorAll('.radio-indicator') as NodeListOf<HTMLElement>;
            radioIndicators.forEach(indicator => {
                indicator.classList.remove('border-primary', 'bg-primary');
                indicator.classList.add('border-white/40');
                indicator.querySelector('div')?.classList.add('hidden');
            });
            
            const card = this.querySelector('.radio-card');
            const indicator = this.querySelector('.radio-indicator');
            const dot = indicator?.querySelector('div');
            
            card?.classList.remove('border-white/20');
            card?.classList.add('border-primary', 'bg-primary/10');
            indicator?.classList.remove('border-white/40');
            indicator?.classList.add('border-primary', 'bg-primary');
            dot?.classList.remove('hidden');
        });
    });
</script>