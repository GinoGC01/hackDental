---
// src/pages/contacto.astro
import Layout from '../layouts/Layout.astro';
import RedLine from '../Icons/RedLine.astro';
import Candado from '../Icons/Candado.astro';
import Spain from '../Icons/Spain.astro';
import Alert from '../components/Alerts/Alert.astro';
import Sparkles from '../Icons/Ebook/Sparkles.astro';
import CornerRightDown from '../Icons/Ebook/CornerRightDown.astro';
---

<Layout>
    <main class="flex flex-col md:flex-row items-start md:items-center justify-between px-4 md:px-8 lg:px-16 m-auto pt-12 md:pt-0 max-w-[1400px] md:gap-16 relative md:min-h-[100vh] py-12 md:py-0">
        
        <div class="md:basis-1/2 w-full relative">
            <Alert id="warning1" color="#fdc700" widthMD="400px" width="120px" message="⚠ Email registrado! revise nuevamente sus datos." />
            <Alert id="error1" color="#ff4d4f" widthMD="400px" width="120px" message="✖ Error al enviar el formulario." />
            <Alert id="success1" color="#52c41a" widthMD="400px" width="120px" message="✔ Solicitud enviada con éxito!" />
            
            <div class="max-w-2xl">
                <div class="mb-12">
                    <h1 class="text-[24px] md:text-[36px] leading-[1.2] font-bold mb-4 font-oswald uppercase">
                        <span class="text-[#d9d9d9]">Recibe una auditoría de</span>
                        <div class="relative inline-block">
                            <span class="text-white">Marketing Dental</span>
                            <figure class="absolute bottom-[-2px] left-0 w-full"><RedLine /></figure>
                        </div>
                        <span class="text-[#d9d9d9]"> hecha por el fundador</span>
                    </h1>
                </div>

                <div class="mb-12 space-y-4">
                    <h2 class="text-[18px] font-semibold mb-6 text-[#d9d9d9]">PASOS PARA APLICAR:</h2>
                    <div class="space-y-4 text-gray-300">
                        <div class="grid items-center gap-4 grid-cols-[40px_1fr]">
                            <div class="flex items-center justify-center w-[35px] h-[35px] bg-[#039683]/10 rounded-lg border border-[#039683]/30">
                                <span class="text-white text-[14px] font-black w-[24px] h-[24px] bg-[#039683] flex items-center justify-center rounded-full">1</span>
                            </div>
                            <p class="text-[17px]">Llena tus datos en la forma.</p>
                        </div>
                        <div class="grid items-center gap-4 grid-cols-[40px_1fr]">
                            <div class="flex items-center justify-center w-[35px] h-[35px] bg-[#039683]/10 rounded-lg border border-[#039683]/30">
                                <span class="text-white text-[14px] font-black w-[24px] h-[24px] bg-[#039683] flex items-center justify-center rounded-full">2</span>
                            </div>
                            <p class="text-[17px]">Espera 24 horas.</p>
                        </div>
                        <div class="grid items-center gap-4 grid-cols-[40px_1fr]">
                            <div class="flex items-center justify-center w-[35px] h-[35px] bg-[#039683]/10 rounded-lg border border-[#039683]/30">
                                <span class="text-white text-[14px] font-black w-[24px] h-[24px] bg-[#039683] flex items-center justify-center rounded-full">3</span>
                            </div>
                            <p class="text-[17px]">Agendaremos una reunión contigo.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-[#111] rounded-2xl border border-white/10 pt-16 pb-8 px-6 md:px-8 md:basis-[45%] lg:basis-[40%] relative w-full shadow-[0_0_50px_rgba(3,150,131,0.15)] overflow-hidden min-h-[620px] flex flex-col justify-center">
            
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#039683] to-transparent opacity-70"></div>
            <div class="absolute w-full top-0 left-0 p-2 bg-[#831022]/60 border-b border-white/10 text-center z-20">
                <p class="text-[10px] md:text-[12px] text-white font-medium uppercase tracking-wider">Solo aplica si tu consultorio está en España</p>
            </div>

            <div class="mb-8 text-center relative z-10">
                <div id='currentSetpConainer' class="flex flex-col items-center gap-2 justify-center relative w-full m-auto">
                    <span id="currentStep" class="text-[#d9d9d9] font-black text-[22px] md:text-[32px] leading-tight uppercase tracking-tighter">ÚLTIMO PASO</span>
                    <div class="w-40 " id="redLine"><RedLine /></div>
                </div>
            </div>

            <form id="contactForm" class="flex flex-col justify-center items-center w-full relative z-10" novalidate>
                
                <div id="step1" class="step-content w-full animate-fadeIn">
                    <div class="space-y-6">
                        <div class="group/field">
                            <div class="flex justify-between items-end mb-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest">Tu Email Profesional *</label>
                                <div class="text-[10px] font-bold text-[#039683] flex items-center gap-1 animate-pulse">
                                    Empieza aquí <CornerRightDown color="#039683" />
                                </div>
                            </div>
                            <div class="relative">
                                <div class="input-shadow-logic absolute -inset-1 rounded-lg blur-md opacity-0 transition-all duration-500"></div>
                                <input 
                                    type="email" id="email" name="email" required placeholder="ejemplo@clinicadental.com"
                                    class="relative w-full px-4 py-4 bg-[#1a1a1a] border border-white/10 rounded-lg text-white focus:outline-none transition-all z-10"
                                    data-order="1"
                                >
                            </div>
                        </div>
                    </div>
                    <button type="button" id="nextStep1" class="w-full bg-gradient-to-r from-[#039683] via-emerald-500 to-[#039683] text-white font-black text-lg py-4 rounded-lg shadow-[0_4px_0_#064e3b] mt-8 uppercase tracking-widest cursor-pointer border-t border-white/20 active:translate-y-1 transition-all">Continuar</button>
                </div>

                <div id="step2" class="step-content hidden w-full animate-fadeIn">
                    <div class="space-y-6">
                        <div class="group/field">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Nombre y Apellido *</label>
                            <div class="relative">
                                <div class="input-shadow-logic absolute -inset-1 rounded-lg blur-md opacity-0 transition-all duration-500"></div>
                                <input type="text" id="nombre" name="nombre" required class="relative w-full px-4 py-3 bg-[#1a1a1a] border border-gray-800 rounded-lg text-white focus:outline-none z-10" data-order="2">
                            </div>
                        </div>
                        <div class="group/field">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sitio Web (opcional)</label>
                            <div class="relative">
                                <div class="input-shadow-logic absolute -inset-1 rounded-lg blur-md opacity-0 transition-all duration-500"></div>
                                <input type="url" id="website" name="website" class="relative w-full px-4 py-3 bg-[#1a1a1a] border border-gray-800 rounded-lg text-white focus:outline-none z-10" data-order="3">
                            </div>
                        </div>
                        <div class="group/field">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Teléfono *</label>
                            <div class="relative">
                                <div class="input-shadow-logic absolute -inset-1 rounded-lg blur-md opacity-0 transition-all duration-500"></div>
                                <div class="absolute left-4 top-1/2 -translate-y-1/2 flex items-center gap-2 z-20 border-r border-white/10 pr-2">
                                    <Spain size="20" /><span class="text-white text-sm font-bold">+34</span>
                                </div>
                                <input type="tel" id="telefono" name="telefono" required class="relative w-full pl-24 pr-4 py-3 bg-[#1a1a1a] border border-gray-800 rounded-lg text-white focus:outline-none z-10" data-order="4">
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 mt-8">
                        <button type="button" id="prevStep2" class="w-1/3 bg-white/5 text-gray-400 font-bold py-4 rounded-lg">Atrás</button>
                        <button type="button" id="nextStep2" class="w-2/3 bg-[#039683] text-white font-black py-4 rounded-lg shadow-[0_4px_0_#064e3b] uppercase">Continuar</button>
                    </div>
                </div>

                <div id="step3" class="step-content hidden w-full animate-fadeIn">
                    <div class="text-center">
                        <span class="inline-flex items-center gap-1.5 bg-[#039683]/10 text-[#039683] text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest border border-[#039683]/20 mb-4">
                            <Sparkles size="16" color="#039683"/> Facturación estimada
                        </span>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-4 tracking-widest">Ingresos Anuales Aproximados (€) *</label>
                        <div class="relative">
                            <div class="input-shadow-logic absolute -inset-1 rounded-lg blur-md opacity-0 transition-all duration-500"></div>
                            <input type="number" id="ingresos" name="ingresos" class="relative w-full px-4 py-4 bg-[#1a1a1a] border border-gray-800 rounded-lg text-white text-center text-xl focus:outline-none z-10" data-order="5">
                        </div>
                    </div>
                    <div class="flex gap-4 mt-8">
                        <button type="button" id="prevStep3" class="w-1/3 bg-white/5 text-gray-400 font-bold py-4 rounded-lg">Atrás</button>
                        <button type="button" id="nextStep3" class="w-2/3 bg-[#039683] text-white font-black py-4 rounded-lg shadow-[0_4px_0_#064e3b] uppercase">Siguiente</button>
                    </div>
                </div>

                <div id="step4" class="step-content hidden w-full animate-fadeIn">
                    <div class="space-y-3">
                        {['mas-pacientes', 'alto-valor', 'presencia-marca'].map((val, i) => (
                            <label class="block cursor-pointer radio-option group">
                                <input type="radio" name="objetivo" value={val} class="hidden"/>
                                <div class="radio-card border border-gray-800 rounded-xl p-4 bg-[#1a1a1a] group-hover:border-[#039683]/50 transition-all">
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-300 font-medium">{i === 0 ? 'Conseguir más pacientes' : i === 1 ? 'Atraer pacientes de alto valor' : 'Mejorar marca'}</span>
                                        <div class="radio-indicator w-5 h-5 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                            <div class="w-2.5 h-2.5 rounded-full bg-[#039683] hidden"></div>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        ))}
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-[#039683] via-emerald-500 to-[#039683] text-white font-black text-xl py-5 rounded-lg shadow-[0_5px_0_#064e3b] mt-8 uppercase tracking-widest flex items-center justify-center gap-3">
                        <span id="text_submitBtn">Si, quiero mi auditoría</span>
                        <span id="loader" class="h-5 w-5 animate-spin rounded-full border-2 border-white/30 border-t-white hidden"></span>
                    </button>
                </div>

                <p class="text-[10px] text-gray-600 text-center mt-8 uppercase font-bold tracking-widest flex items-center gap-2">
                    <Candado size="14" color="#4B5563"/> Privacidad garantizada y encriptada
                </p>
            </form>  
        </div>
    </main>
</Layout>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
    
    /* Clases de utilidad para la lógica de sombras */
    .glow-red { 
        background-color: #831022 !important; 
        opacity: 0.6 !important; 
        filter: blur(10px) !important;
        animation: pulseShadow 2s infinite;
    }
    .glow-green { 
        background-color: #039683 !important; 
        opacity: 0.8 !important; 
        filter: blur(14px) !important;
    }
    .glow-none { opacity: 0 !important; }

    @keyframes pulseShadow {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 0.7; }
    }
</style>

<script>
    import {ApiService} from '../api/service.js';
    let currentStep = 1;

    // --- LÓGICA DE SOMBRAS SECUENCIALES ---
    function refreshShadows() {
        const step = document.getElementById(`step${currentStep}`);
        if (!step || currentStep === 4) {
            // Limpiar sombras en el paso de objetivos
            document.querySelectorAll('.input-shadow-logic').forEach(s => s.className = 'input-shadow-logic absolute -inset-1 rounded-lg blur-md opacity-0 transition-all duration-500');
            return;
        }

        const inputs = Array.from(step.querySelectorAll('input:not([type="radio"])')) as HTMLInputElement[];
        let foundFirstEmpty = false;

        inputs.forEach((input) => {
            const shadow = input.parentElement?.querySelector('.input-shadow-logic');
            if (!shadow) return;

            const isFocused = document.activeElement === input;
            const isEmpty = input.value.trim() === "";

            // Reset inicial
            shadow.classList.remove('glow-red', 'glow-green', 'glow-none');

            if (isFocused) {
                shadow.classList.add('glow-green');
                foundFirstEmpty = true; // Si está enfocado, bloqueamos la roja para los siguientes
            } else if (!foundFirstEmpty && isEmpty) {
                shadow.classList.add('glow-red');
                foundFirstEmpty = true; // Solo el primer vacío del orden secuencial es rojo
            } else {
                shadow.classList.add('glow-none');
            }
        });
    }

    function setupShadowListeners() {
        const allInputs = document.querySelectorAll('input:not([type="radio"])');
        allInputs.forEach(input => {
            input.addEventListener('focus', refreshShadows);
            input.addEventListener('blur', refreshShadows);
            input.addEventListener('input', refreshShadows);
        });
    }

    // --- NAVEGACIÓN Y UI ---
    function updateProgress() {
        const currentStepText = document.getElementById('currentStep');
        const redLine = document.getElementById('redLine');
        if (currentStepText && redLine) {
            if (currentStep === 1) { currentStepText.innerText = 'ÚLTIMO PASO'; redLine.classList.remove('hidden'); }
            else { redLine.classList.add('hidden'); }
            if (currentStep === 2) currentStepText.innerText = 'INGRESA TU INFORMACION AQUI PARA RECIBIR TU AUDITORIA';
            if (currentStep === 3) currentStepText.innerText = 'TU CLÍNICA';
            if (currentStep === 4) currentStepText.innerText = '¿LISTO PARA DISCUTIR EL FUTURO DE TU CONSULTORIO DENTAL?';
        }
        refreshShadows();
    }

    function showStep(step: number) {
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step${step}`)?.classList.remove('hidden');
        currentStep = step;
        updateProgress();
    }

    // --- VALIDACIONES ---
    const validateStep1 = () => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((document.getElementById('email') as HTMLInputElement).value);
    const validateStep2 = () => {
        const n = (document.getElementById('nombre') as HTMLInputElement).value;
        const t = (document.getElementById('telefono') as HTMLInputElement).value;
        return n.length > 2 && t.length > 7;
    };
    const validateStep3 = () => (document.getElementById('ingresos') as HTMLInputElement).value !== "";

    // --- EVENT LISTENERS ---
    document.getElementById('nextStep1')?.addEventListener('click', () => validateStep1() ? showStep(2) : alert("Email inválido"));
    document.getElementById('nextStep2')?.addEventListener('click', () => validateStep2() ? showStep(3) : alert("Completa los datos"));
    document.getElementById('nextStep3')?.addEventListener('click', () => validateStep3() ? showStep(4) : alert("Ingresa un valor"));
    document.getElementById('prevStep2')?.addEventListener('click', () => showStep(1));
    document.getElementById('prevStep3')?.addEventListener('click', () => showStep(2));

    // --- FORM SUBMIT ---
    document.getElementById("contactForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
        const loader = document.getElementById("loader");
        const textBtn = document.getElementById("text_submitBtn");
        
        const objetivo = (document.querySelector('input[name="objetivo"]:checked') as HTMLInputElement)?.value;
        if(!objetivo) return alert("Selecciona un objetivo");

        try {
            submitBtn.disabled = true;
            loader?.classList.remove("hidden");
            textBtn?.classList.add("hidden");

            const formData = {
                nombre: (document.getElementById("nombre") as HTMLInputElement).value,
                email: (document.getElementById("email") as HTMLInputElement).value,
                website: (document.getElementById("website") as HTMLInputElement).value,
                telefono: "+34" + (document.getElementById("telefono") as HTMLInputElement).value,
                ingresos: (document.getElementById("ingresos") as HTMLInputElement).value,
                objetivo
            };

            const res = await ApiService.sendData(formData);
            if(res && (res.success || res.warning === 'email-registered')) {
                if(res.success) document.getElementById("success1")?.classList.remove("hidden");
                if(res.warning) document.getElementById("warning1")?.classList.remove("hidden");
                (e.target as HTMLFormElement).reset();
                showStep(1);
            } else {
                document.getElementById("error1")?.classList.remove("hidden");
            }
        } catch (err) {
            document.getElementById("error1")?.classList.remove("hidden");
        } finally {
            submitBtn.disabled = false;
            loader?.classList.add("hidden");
            textBtn?.classList.remove("hidden");
        }
    });

    // --- INICIALIZACIÓN ---
    setupShadowListeners();
    refreshShadows();

    document.querySelectorAll('.radio-option').forEach(label => {
        label.addEventListener('click', function(this: HTMLElement) {
            document.querySelectorAll('.radio-card').forEach(c => c.classList.remove('border-[#039683]', 'bg-[#039683]/10'));
            document.querySelectorAll('.radio-indicator div').forEach(d => d.classList.add('hidden'));
            this.querySelector('.radio-card')?.classList.add('border-[#039683]', 'bg-[#039683]/10');
            this.querySelector('.radio-indicator div')?.classList.remove('hidden');
        });
    });
</script>